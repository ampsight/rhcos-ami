---
# tasks file for rhcos-ami

# Set a large timeout as it could take awhile to download the file
- name: Download the VMDK file
  get_url:
    url: "{{ base_url }}/{{ ocp_maj_ver }}/{{ ocp_min_ver }}/rhcos-{{ ocp_min_ver }}-x86_64-aws.x86_64.vmdk.gz"
    dest: "{{ vmdk_tmp }}"
    mode: '0644'
    timeout: 600
  tags:
    - download

# EC2 Import Snapshot will not take a compressed archive like gzip
- name: Decompress the VMDK file
  command: gunzip "{{ vmdk_tmp }}/rhcos-{{ ocp_min_ver }}-x86_64-aws.x86_64.vmdk.gz"
  tags:
    - decompress

# TODO: Hardcoded to put the vmdk into the root of the S3 bucket.
#       Update role to support non-root directory level
- name: Upload VMDK to S3 Bucket
  aws_s3:
    aws_access_key: "{{ lookup('env','AWS_ACCESS_KEY_ID') }}"
    aws_secret_key: "{{ lookup('env','AWS_SECRET_ACCESS_KEY') }}"
    bucket: "{{ s3_bucket }}"
    src: "{{ vmdk_tmp }}/rhcos-{{ ocp_min_ver }}-x86_64-aws.x86_64.vmdk"
    object: "/rhcos-{{ ocp_min_ver }}-x86_64-aws.x86_64.vmdk"
    mode: put
    overwrite: true
  tags:
    - upload

- name: Remove the decompressed VMDK from the local system
  file:
    path: "{{ vmdk_tmp }}/rhcos-{{ ocp_min_ver }}-x86_64-aws.x86_64.vmdk"
    state: absent
  when: (cleanup_local | bool)

# This requires that your IAM user is allowed to create the role
# This step can be skipped if the role already exists
- name: Create VMImport Role in AWS
  import_role:
    name: rubrik-devops.aws-vmimport-role
  vars:
    s3_bucket_name: "{{ s3_bucket }}"
    s3_bucket_arn: "arn:aws:s3:::{{  s3_bucket }}"
  when: (create_role | bool)

- name: Create JSON file for use with importing snapshot
  template:
    src: containers.json.j2
    dest: /tmp/containers.json

- name: Import Snapshot from RHCOS VMDK in S3
  command: |
    aws ec2 import-snapshot \
    --description "Red Hat CoreOS {{ ocp_min_ver }} VMDK" \
    --disk-container "file:///tmp/containers.json" \
    --output text --query 'ImportTaskId'
  register: import_snapshot

- name: Wait for snapshot import to complete
  command: aws ec2 describe-import-snapshot-tasks \
           --import-task-ids "{{ import_snapshot.stdout }}" \
           --output text \
           --query 'ImportSnapshotTasks[*].SnapshotTaskDetail.Status'
  register: snapshot_status
  until: snapshot_status.stdout == 'completed'
  retries: 60
  delay: 30

- name: Remove containers.json after import snapshot
  file:
    path: /tmp/containers.json
    state: absent
  when: (cleanup_local | bool)

- name: Get the snapshot id
  command: aws ec2 describe-import-snapshot-tasks \
           --import-task-ids "{{ import_snapshot.stdout }}" \
           --output text \
           --query 'ImportSnapshotTasks[*].SnapshotTaskDetail.SnapshotId'
  register: snapshot_id

# TODO: There should be an ephemeral device on /dev/xvdb
- name: Register AMI against the snapshot
  ec2_ami:
    name: "rhcos-{{ ocp_min_ver }}-x86_64"
    state: present
    architecture: x86_64
    virtualization_type: hvm
    root_device_name: /dev/xvda
    wait: true
    device_mapping:
      - device_name: /dev/xvda
        volume_size: 16
        delete_on_termination: true
        volume_type: gp2
        snapshot_id: "{{ snapshot_id.stdout }}"
  tags:
    - register

- name: Cleanup the VMDK file on S3
  aws_s3:
    aws_access_key: "{{ lookup('env','AWS_ACCESS_KEY_ID') }}"
    aws_secret_key: "{{ lookup('env','AWS_SECRET_ACCESS_KEY') }}"
    bucket: "{{ s3_bucket }}"
    object: "/rhcos-{{ ocp_min_ver }}-x86_64-aws.x86_64.vmdk"
    mode: delete
  when: (cleanup_s3 | bool)
