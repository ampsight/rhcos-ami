---
# tasks file for rhcos-ami

  # Set a large timeout as it could take awhile to download the file
- name: Download the VMDK file
  get_url:
    url: "{{ base_url }}/{{ ocp_maj_ver }}/{{ ocp_min_ver }}/rhcos-{{ ocp_min_ver }}-x86_64-aws.x86_64.vmdk.gz"
    dest: "{{ vmdk_tmp }}"
    mode: '0644'
    timeout: 600
  tags:
    - download

  # EC2 Import Snapshot will not take a compressed archive like gzip
- name: Decompress the VMDK file
  command: gunzip "{{ vmdk_tmp }}/rhcos-{{ ocp_min_ver }}-x86_64-aws.x86_64.vmdk.gz"
  tags:
    - decompress

  # TODO: Hardcoded to put the vmdk into the root of the S3 bucket.
  #       Update role to support non-root directory level
- name: Upload VMDK to S3 Bucket
  aws_s3:
    aws_access_key: "{{ aws_access_key_id }}"
    aws_secret_key: "{{ aws_secret_access_key }}"
    bucket: "{{ s3_bucket }}"
    src: "{{ vmdk_tmp }}/rhcos-{{ ocp_min_ver }}-x86_64-aws.x86_64.vmdk"
    object: "/rhcos-{{ ocp_min_ver }}-x86_64-aws.x86_64.vmdk"
    mode: put
    overwrite: true
  tags:
    - upload

#- name: Create Import Snapshot Role
#  when: (create_role | bool)

- name: Create JSON file for use with importing snapshot
  template:
    src: containers.json.j2
    dest: /tmp/containers.json

#  # TODO: Register the resulting snapshot ID for use in subsequent tasks
#- name: Import Snapshot from RHCOS VMDK in S3
#
#- name: Create JSON file for use with registering AMI
#
- name: Register AMI against the snapshot
  ec2_ami:
    name: newtest
    state: present
    architecture: x86_64
    virtualization_type: hvm
    root_device_name: /dev/xvda
    device_mapping:
      - device_name: /dev/xvda
        volume_size: 8
        snapshot_id: snap-xxxxxxxx
        delete_on_termination: true
        volume_type: gp2

